# Интерпритаторы и компиляторы

Для того, что бы машина выполнила ваш код его нужно сначала преобразовать в машинный код. Для это и существуют компиляторы и интерпритаторы.

**Интерпритатор** — программа, которая выолняет построчный анализ и выполнение исходного кода. При данном подходе ошибки в программе обнаружатся только при её выполнении.

**Компилятор** — программа, которая анализирует ваш код и преобразует в байт-код с дополнительниыми оптимизациями. При данном подходе компилятор во время анализа кода укажет, где программа будет выполняться неверно и прекратит свою работу.

**Динамическая компиляция / JIT-компиляция(Just in Time compilation)** — Это совмещение двух подходов. Сначала компилятор преобразует программу в машинный код без дополнительных оптимизаций, что ускоряет время до начала его выполнения. В браузерах для этого был добавлен профилировщик, который анализирует код и может сообщить об ошибках на начальном этапе.

## JavaScript-движок

**Абстрактные синтаксические деревья.** — изначальный код, который разобран и представлен в виде дерева.

<details>
<summary>Пример кода:</summary>

```js
function foo() {
	var bar = 10;
}
```
</details>

<details>
<summary>Как выглядит синтаксическое дерево:</summary>

```json
{
    "type": "Program",
    "body": [
        {
            "type": "FunctionDeclaration",
            "id": {
                "type": "Identifier",
                "name": "foo"
            },
            "params": [],
            "body": {
                "type": "BlockStatement",
                "body": [
                    {
                        "type": "VariableDeclaration",
                        "declarations": [
                            {
                                "type": "VariableDeclarator",
                                "id": {
                                    "type": "Identifier",
                                    "name": "bar"
                                },
                                "init": {
                                    "type": "Literal",
                                    "value": 10,
                                    "raw": "10"
                                }
                            }
                        ],
                        "kind": "var"
                    }
                ]
            },
            "generator": false,
            "expression": false,
            "async": false
        }
    ],
    "sourceType": "script"
}
```
</details>


**Движок** — интеприятатор, который выполняет наш код. Он может быть написан с помощью разных приёмов: обычный интерпритатор, JIT-компилятор, который перед выполнением программы преобраузет исходный код в байт-код некоего формата.

Движок работает следующим образом: У нас есть `куча (Memory Heap)` и `стек вызовов (Call stack)`. В стек записывается место, где сейчас находится наш указатель и происходит выполнение функции, где в стек попадают команды для выполнения, а потом выполняются сверху вниз, потому что так работает стек.

### Пример кода:
```js
function multiply(x, y) {
    return x * y;
}
function printSquare(x) {
    var s = multiply(x, x);
    console.log(s);
}
printSquare(5);
```

#### Схема стека, для код выше:
![Пример кода](stack-example.png)

### Пример переполнения стека:
```js
function foo() {
    foo()
}

foo()
```

#### Схема переполнения стека:
![Пример кода](stack-example.png)

## Полезные ссылки
* [Устройство JavaScript-движков](http://jsflow.org/docs/js-engines/)
* http://esprima.org/demo/parse.html?code=function%20foo()%20%7B%0A%09var%20bar%20%3D%2010%3B%0A%7D
* [Как работают сжиматели JavaScript](https://learn.javascript.ru/minification)
* [Создание языка программирования с использованием LLVM. Часть 4: Добавление JIT и поддержки оптимизатора](https://habr.com/en/post/120516/)
* [JIT-компиляция](https://ru.wikipedia.org/wiki/JIT-компиляция)
* [Как работает JS: о внутреннем устройстве V8 и оптимизации кода](https://habr.com/ru/company/ruvds/blog/337460/)
* [Как работает JS: обзор движка, механизмов времени выполнения, стека вызовов](https://habr.com/en/company/ruvds/blog/337042/)
* [Как работает JS: абстрактные синтаксические деревья, парсинг и его оптимизация](https://habr.com/en/company/ruvds/blog/415269/)
* https://github.com/sq/JSIL/wiki/Optimizing-dynamic-JavaScript-with-inline-caches